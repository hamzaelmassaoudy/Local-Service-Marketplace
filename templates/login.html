{% extends 'base.html' %}

{% block title %}Login | LocalPro{% endblock %}

{% block content %}
<div class="min-h-[calc(100vh-80px)] flex items-center justify-center bg-slate-50">
    <div class="bg-white w-full max-w-md p-8 rounded-2xl shadow-lg border border-gray-100">
        <h1 class="text-3xl font-extrabold text-slate-900 mb-6 text-center">Welcome Back</h1>
        
        <form onsubmit="handleLogin(event)" class="space-y-4">
            <div>
                <label class="block text-sm font-bold text-slate-700 mb-1">Email</label>
                <input id="email" type="email" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand focus:border-brand outline-none transition" placeholder="you@example.com" required>
            </div>
            <div>
                <label class="block text-sm font-bold text-slate-700 mb-1">Password</label>
                <input id="password" type="password" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand focus:border-brand outline-none transition" placeholder="••••••••" required>
            </div>
            <button class="w-full bg-brand hover:bg-green-600 text-white font-bold py-3.5 rounded-xl transition shadow-lg shadow-brand/20">Sign In</button>
        </form>

        <p class="text-center mt-6 text-slate-500">
            Don't have an account? <a href="/register/" class="text-brand font-bold hover:underline">Join Now</a>
        </p>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    const API_URL = 'http://127.0.0.1:8000/api/v1';

    const API = {
        fetch: async (endpoint, method='GET', body=null) => {
            const opts = { method, headers: { 'Content-Type': 'application/json' } };
            if(body) opts.body = JSON.stringify(body);
            try {
                const res = await fetch(API_URL + endpoint, opts);
                const data = await res.json();
                return res.ok ? data : null;
            } catch(e) { console.error(e); return null; }
        }
    };

    async function handleLogin(e) {
        e.preventDefault();
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        
        const res = await API.fetch('/auth/login/', 'POST', { email, password });
        
        if(res && res.access) {
            localStorage.setItem('token', res.access);
            localStorage.setItem('user', JSON.stringify(res.user));
            
            // --- FIXED REDIRECTS HERE ---
            if (res.user.is_provider) {
                window.location.href = '/provider/'; // Changed from /provider.html
            } else {
                window.location.href = '/';
            }
        } else {
            alert("Login Failed: Invalid email or password.");
        }
    }
</script>
{% endblock %}