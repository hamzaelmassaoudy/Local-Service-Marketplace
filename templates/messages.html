{% extends 'base.html' %}

{% block title %}Messages | LocalPro{% endblock %}

{% block content %}
<div class="h-[calc(100vh-80px)] bg-white flex overflow-hidden">
    
    <div class="w-full md:w-96 border-r border-gray-200 flex flex-col bg-slate-50">
        <div class="p-4 border-b border-gray-200 bg-white shadow-sm z-10 flex justify-between items-center">
            <h2 class="text-xl font-extrabold text-slate-800">Messages</h2>
            <div id="ws-status" class="flex items-center gap-2 text-xs font-bold text-gray-400">
                <span class="w-2.5 h-2.5 rounded-full bg-gray-300 transition-colors" id="ws-dot"></span>
                <span id="ws-text">Offline</span>
            </div>
        </div>
        <div id="conversation-list" class="flex-1 overflow-y-auto">
            <div class="p-10 text-center text-gray-400 flex flex-col items-center gap-2">
                <i class="fa-solid fa-circle-notch fa-spin text-2xl"></i>
                <p class="text-sm">Loading conversations...</p>
            </div>
        </div>
    </div>

    <div class="flex-1 flex flex-col bg-white relative">
        
        <div id="chat-header" class="h-16 border-b border-gray-200 flex items-center justify-between px-6 bg-white hidden shadow-sm z-10">
            
            <a id="header-profile-link" href="#" class="flex items-center gap-3 hover:bg-slate-50 p-2 rounded-lg transition group">
                <img id="header-img" src="" class="w-10 h-10 rounded-full object-cover bg-slate-200 border border-gray-200 shadow-sm">
                <div>
                    <h3 id="header-name" class="font-bold text-slate-800 group-hover:text-brand transition text-sm md:text-base">User</h3>
                    <div class="flex items-center gap-2">
                        <span id="header-role" class="text-[10px] uppercase font-bold px-1.5 py-0.5 rounded bg-slate-100 text-slate-500">Role</span>
                        <span class="text-xs text-gray-300">|</span>
                        <p id="header-status" class="text-xs text-gray-500 font-medium">Status</p>
                    </div>
                </div>
            </a>

            <div class="flex gap-4">
                <button class="text-slate-300 hover:text-slate-600 transition" title="Booking Details">
                    <i class="fa-solid fa-circle-info text-xl"></i>
                </button>
            </div>
        </div>

        <div id="messages-container" class="flex-1 overflow-y-auto p-6 space-y-6 bg-slate-50/50 scroll-smooth">
            <div class="h-full flex flex-col items-center justify-center text-gray-300">
                <div class="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center mb-4 text-3xl">
                    <i class="fa-regular fa-comments text-slate-300"></i>
                </div>
                <p class="font-medium">Select a conversation to start chatting.</p>
            </div>
        </div>

        <div id="input-area" class="p-4 bg-white border-t border-gray-200 hidden">
            <form onsubmit="Messenger.send(event)" class="flex gap-2 max-w-4xl mx-auto">
                <input id="msg-input" class="flex-grow p-3.5 bg-slate-100 border-none rounded-xl focus:ring-2 focus:ring-brand outline-none transition text-slate-800 placeholder-slate-400" placeholder="Type a message..." autocomplete="off">
                <button id="send-btn" class="bg-brand hover:bg-green-600 text-white px-6 rounded-xl font-bold transition shadow-md flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fa-solid fa-paper-plane"></i>
                </button>
            </form>
        </div>

    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    const API_URL = 'http://127.0.0.1:8000/api/v1';
    const currentUser = JSON.parse(localStorage.getItem('user'));
    const token = localStorage.getItem('token');
    
    // Redirect if not logged in
    if(!currentUser || !token) window.location.href = '/login/';

    const API = {
        fetch: async (endpoint, method='GET', body=null) => {
            const opts = { method, headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` } };
            if(body) opts.body = JSON.stringify(body);
            try { const res = await fetch(API_URL + endpoint, opts); return await res.json(); } catch(e) { return null; }
        }
    };

    const Messenger = {
        activeSocket: null,
        activeBookingId: null,
        reconnectInterval: null,

        init: async () => {
            // 1. Fetch Conversations (Bookings)
            const bookings = await API.fetch('/bookings/my-bookings/');
            const list = document.getElementById('conversation-list');
            
            if(!bookings || bookings.length === 0) {
                list.innerHTML = `
                    <div class="p-10 text-center text-gray-400 flex flex-col items-center">
                        <i class="fa-regular fa-folder-open text-3xl mb-3"></i>
                        <p class="text-sm">No active bookings found.</p>
                        <a href="/" class="text-brand font-bold text-xs mt-2 hover:underline">Find a Service</a>
                    </div>`;
                return;
            }

            // 2. Render List
            list.innerHTML = bookings.map(b => {
                const isMeProvider = currentUser.is_provider;
                const otherUser = isMeProvider ? b.customer_detail : b.provider_detail;
                
                const name = otherUser ? otherUser.username : "Unknown User";
                const img = otherUser && otherUser.profile_image ? otherUser.profile_image : `https://ui-avatars.com/api/?name=${name}&background=random`;
                const role = isMeProvider ? 'Customer' : 'Provider';

                let statusColor = 'bg-slate-100 text-slate-500';
                if(b.status === 'ACCEPTED') statusColor = 'bg-blue-100 text-blue-600';
                if(b.status === 'COMPLETED') statusColor = 'bg-green-100 text-green-600';

                return `
                <div id="chat-${b.id}" onclick="Messenger.loadChat('${b.id}', '${name}', '${img}', '${b.status}', '${role}')" class="p-4 border-b border-gray-100 hover:bg-slate-100 cursor-pointer transition flex items-center gap-4 group">
                    <div class="relative">
                        <img src="${img}" class="w-12 h-12 rounded-full object-cover border border-gray-200">
                    </div>
                    <div class="flex-grow overflow-hidden">
                        <div class="flex justify-between items-center mb-1">
                            <h4 class="font-bold text-slate-800 truncate text-sm">${name}</h4>
                            <span class="text-[10px] px-2 py-0.5 rounded-full font-bold uppercase ${statusColor}">${b.status}</span>
                        </div>
                        <p class="text-xs text-slate-500 truncate group-hover:text-brand transition">${b.service_detail.title}</p>
                    </div>
                </div>`;
            }).join('');

            // 3. Auto-open chat if ?id= is in URL
            const urlParams = new URLSearchParams(window.location.search);
            const targetId = urlParams.get('id');
            if (targetId) {
                const el = document.getElementById(`chat-${targetId}`);
                if(el) el.click();
            }
        },

        loadChat: async (bookingId, name, img, status, role) => {
            document.querySelectorAll('#conversation-list > div').forEach(d => d.classList.remove('bg-slate-100'));
            const activeEl = document.getElementById(`chat-${bookingId}`);
            if(activeEl) activeEl.classList.add('bg-slate-100');

            Messenger.activeBookingId = bookingId;
            
            // UI Updates
            document.getElementById('chat-header').classList.remove('hidden');
            document.getElementById('input-area').classList.remove('hidden');
            document.getElementById('header-name').innerText = name;
            document.getElementById('header-img').src = img;
            document.getElementById('header-status').innerText = status;
            document.getElementById('header-role').innerText = role;
            
            const badge = document.getElementById('header-role');
            if(role === 'Provider') badge.className = "text-[10px] uppercase font-bold px-1.5 py-0.5 rounded bg-brand/10 text-brand";
            else badge.className = "text-[10px] uppercase font-bold px-1.5 py-0.5 rounded bg-blue-100 text-blue-600";

            document.getElementById('header-profile-link').href = `/public-profile.html?u=${name}`;
            document.getElementById('messages-container').innerHTML = '<div class="h-full flex items-center justify-center"><i class="fa-solid fa-circle-notch fa-spin text-brand text-2xl"></i></div>';

            Messenger.connectSocket();

            // Fetch History
            try {
                const msgs = await API.fetch(`/chat/${bookingId}/messages/`);
                const container = document.getElementById('messages-container');
                container.innerHTML = '';
                
                if(msgs && msgs.length > 0) {
                    msgs.forEach(m => Messenger.appendMessage(m));
                } else {
                    container.innerHTML = `
                        <div class="h-full flex flex-col items-center justify-center text-gray-300">
                            <i class="fa-regular fa-paper-plane text-4xl mb-2 opacity-50"></i>
                            <p class="text-sm">No messages yet. Say hi!</p>
                        </div>`;
                }
            } catch(e) {
                document.getElementById('messages-container').innerHTML = '<div class="text-red-500 text-center mt-10">Failed to load messages.</div>';
            }
        },

        connectSocket: () => {
            if(Messenger.activeSocket) Messenger.activeSocket.close();
            if(Messenger.reconnectInterval) clearInterval(Messenger.reconnectInterval);

            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            Messenger.activeSocket = new WebSocket(`${protocol}//${window.location.host}/ws/chat/${Messenger.activeBookingId}/`);
            
            Messenger.activeSocket.onopen = () => {
                Messenger.updateStatus(true);
            };
            
            Messenger.activeSocket.onmessage = (e) => Messenger.appendMessage(JSON.parse(e.data).message);
            
            Messenger.activeSocket.onclose = () => {
                Messenger.updateStatus(false);
                // Auto-reconnect every 3 seconds
                if(!Messenger.reconnectInterval) {
                    Messenger.reconnectInterval = setInterval(() => {
                        if(Messenger.activeBookingId) Messenger.connectSocket();
                    }, 3000);
                }
            };
        },

        updateStatus: (isOnline) => {
            const dot = document.getElementById('ws-dot');
            const text = document.getElementById('ws-text');
            const btn = document.getElementById('send-btn');
            
            if(isOnline) {
                dot.classList.remove('bg-red-500', 'bg-gray-300');
                dot.classList.add('bg-green-500');
                text.innerText = "Online";
                text.classList.add('text-green-600');
                btn.disabled = false;
                if(Messenger.reconnectInterval) clearInterval(Messenger.reconnectInterval);
                Messenger.reconnectInterval = null;
            } else {
                dot.classList.remove('bg-green-500', 'bg-gray-300');
                dot.classList.add('bg-red-500');
                text.innerText = "Connecting...";
                text.classList.remove('text-green-600');
                btn.disabled = true;
            }
        },

        appendMessage: (m) => {
            const container = document.getElementById('messages-container');
            if(container.innerText.includes('No messages yet')) container.innerHTML = '';

            const isMe = m.sender === currentUser.id;
            const role = m.sender_role || 'User'; 
            const roleColor = role === 'Provider' ? 'text-brand bg-brand/5 border-brand/10' : 'text-blue-600 bg-blue-50 border-blue-100';
            const avatarUrl = m.sender_detail.profile_image || `https://ui-avatars.com/api/?name=${m.sender_detail.username}&background=random`;

            const div = document.createElement('div');
            div.className = `flex w-full gap-3 mb-4 ${isMe ? 'flex-row-reverse' : 'flex-row'}`;
            
            const avatarHtml = isMe ? 
                `<img src="${avatarUrl}" class="w-8 h-8 rounded-full object-cover border border-gray-200 shadow-sm">` :
                `<a href="/public-profile.html?u=${m.sender_detail.username}" title="View Profile" class="hover:opacity-80 transition"><img src="${avatarUrl}" class="w-8 h-8 rounded-full object-cover border border-gray-200 shadow-sm"></a>`;

            div.innerHTML = `
                <div class="flex-shrink-0 flex flex-col items-center pt-1">${avatarHtml}</div>
                <div class="flex flex-col ${isMe ? 'items-end' : 'items-start'} max-w-[75%] md:max-w-[60%]">
                    <div class="flex items-center gap-2 mb-1 px-1">
                        <span class="text-xs font-bold text-slate-700">${m.sender_detail.username}</span>
                        <span class="text-[9px] px-1.5 py-0.5 rounded border font-bold uppercase tracking-wider ${roleColor}">${role}</span>
                    </div>
                    <div class="px-5 py-3 rounded-2xl text-sm shadow-sm leading-relaxed ${isMe ? 'bg-brand text-white rounded-tr-none' : 'bg-white text-slate-800 border border-gray-100 rounded-tl-none'}">${m.text}</div>
                    <span class="text-[10px] text-gray-400 mt-1">${new Date(m.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                </div>`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        },

        send: (e) => {
            e.preventDefault();
            const input = document.getElementById('msg-input');
            if(!input.value) return;
            
            if(Messenger.activeSocket && Messenger.activeSocket.readyState === WebSocket.OPEN) {
                Messenger.activeSocket.send(JSON.stringify({ 'message': input.value }));
                input.value = '';
            } else {
                // If not ready, wait a bit and try again
                const btn = document.getElementById('send-btn');
                btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i>';
                setTimeout(() => {
                    if(Messenger.activeSocket.readyState === WebSocket.OPEN) {
                        Messenger.activeSocket.send(JSON.stringify({ 'message': input.value }));
                        input.value = '';
                    }
                    btn.innerHTML = '<i class="fa-solid fa-paper-plane"></i>';
                }, 1000);
            }
        }
    };

    Messenger.init();
</script>
{% endblock %}